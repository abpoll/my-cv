
\documentclass[11pt,article,oneside]{memoir}
\usepackage[english]{babel}
\usepackage{titlesec}
\usepackage{setspace}

% margins
\usepackage[left=1.25in, right=1.75in, top=1in, bottom=0.75in]{geometry}% adjust the page margins

\RequirePackage{xcolor}
\definecolor{CornellRed}{HTML}{b31b1b} % official Cornell blue color -- use for text etc
\definecolor{CornellGray}{HTML}{222222} % official Cornell gray -- use for Section
\definecolor{LightGray}{HTML}{F7F7F7} % background color -- do not use for anything else
\definecolor{BrickRed}{HTML}{C04829} % backup color
\definecolor{GrassGreen}{HTML}{359245}
\definecolor{WarmYellow}{HTML}{E9A139}

%% Choose fonts for use with xelatex
\usepackage{fontspec}
\setmainfont[Path=fonts/,
Mapping={tex-text},
Numbers={OldStyle},
Ligatures={Common},
UprightFont=*-Regular,
BoldFont=*-Bold
]{CrimsonText}
\setsansfont[Path=fonts/,
Mapping=tex-text,
Colour=b31b1b,
UprightFont=*-Regular,
BoldFont=*-Bold,
ItalicFont=*-Italic]{Lato}
\setmonofont[Path=fonts/,
Mapping=tex-text,
Scale=0.9,
UprightFont=*-Regular]{Inconsolata}

%%------------------------------------------------------------------------
%% Section styling
%%------------------------------------------------------------------------

%% This includes a fudge from the following link in order to get the
%% subsection to align with a section
%% http://tex.stackexchange.com/questions/19200/titlesec-remove-space-after-empty-margin-section

\makeatletter
\newif\ifaftersec\aftersecfalse

\newcommand\setsubskip{%
    \global\aftersectrue
    \everypar{%
        \global\aftersecfalse
        \if@noskipsec
            \global\@noskipsecfalse
            \clubpenalty\@M
            \hskip-\parindent
            \begingroup
                \@svsechd\unskip{\hspace{\@tempskipb}}%
            \endgroup
        \else
            \clubpenalty\@clubpenalty\everypar{}%
        \fi}}

\newcommand\subskip{%
  \ifaftersec
     \removelastskip%         EDIT 2
     \vspace{-\baselineskip}% EDIT 2 ??????????????
  \fi
  \global\aftersecfalse}

% Section styling
\titleformat{\section}[leftmargin]{\raggedleft\sffamily\bfseries\footnotesize}{}{0pt}{}[\setsubskip]
\titlespacing*{\section}{2cm}{1ex}{0cm}

% Subsection styling
\titleformat{\subsection}{\subskip\itshape}{}{0pt}{}[]
\titlespacing*{\subsection}{0em}{2.5ex}{1ex}

\raggedbottom
\makeatother

% useful macro
\newcommand{\dotspace}{\quad}

% better lists
\usepackage{enumitem}
\setlist[itemize]{nosep, noitemsep, labelsep=0pt, after=\vspace{\baselineskip}}

% Use BibLaTeX
\usepackage{csquotes}
\usepackage[
	backend=biber,
	style=publist,
	plauthorfirstinit=true,
	plauthorhandling=highlight,
	plnumbered=false,
	labeldateparts=false,
	%linktitleall=true,
	boldyear=false,
	marginyear=false,
	doi=true,
	url=false,
	isbn=false,
	maxbibnames=99,
	maxcitenames=99,
]{biblatex}

\nocite{*}

\def\printbib#1{
\newrefcontext[sorting=none]
\printbibliography[category=#1,heading=#1,omitnumbers=false]}

\DeclareFieldFormat{url}{\url{#1}}
\DeclareFieldFormat[article]{pages}{#1}
\DeclareFieldFormat[inproceedings]{pages}{\lowercase{pp.}#1}
\DeclareFieldFormat[incollection]{pages}{\lowercase{pp.}#1}
\DeclareFieldFormat[article]{volume}{\mkbibbold{#1}}
\DeclareFieldFormat[article]{number}{\mkbibparens{#1}}
\DeclareFieldFormat[article]{title}{\MakeCapital{#1}}
\DeclareFieldFormat[article]{url}{}
\DeclareFieldFormat[inproceedings]{title}{#1}
\DeclareFieldFormat{shorthandwidth}{#1}
\DeclareFieldFormat{extrayear}{}

% Remove In: for an article.
\renewbibmacro{in:}{%
  \ifentrytype{article}{}{%
  \printtext{\bibstring{in}\intitlepunct}}}

% Bibliography categories
\def\makebibcategory#1#2{\DeclareBibliographyCategory{#1}\defbibheading{#1}{\subsection*{#2}}}
\makebibcategory{papers}{Peer-Reviewed Journal Articles}
\makebibcategory{review}{Papers In Review or Forthcoming}
\makebibcategory{books}{Books}
\makebibcategory{chapters}{Book Chapters}
\makebibcategory{conferences}{Conference Papers}
\makebibcategory{talks}{Conference Talks}
\makebibcategory{posters}{Conference Posters}
\makebibcategory{editorials}{Editorials}
\makebibcategory{phd}{PhD Theses}
\makebibcategory{other}{Reviews, software \& other writing}

((* set papers = data.publications | selectattr("ENTRYTYPE", "equalto", "article") *))
((* set review = data.publications | selectattr("ENTRYTYPE", "equalto", "unpublished") *))
((* set conference = data.publications | selectattr("ENTRYTYPE", "equalto", "inproceedings") *))
((* set talks = data.publications | selectattr("ENTRYTYPE", "equalto", "talk") *))
((* set posters = data.publications | selectattr("ENTRYTYPE", "equalto", "poster") *))

\addbibresource[datatype=bibtex]{bibliography/library.bib}
\addbibresource[datatype=bibtex]{bibliography/conferences.bib}

\addtocategory{papers}{((* for i in papers *)) (((i.ID))) ((* if not loop.last *)), ((* endif *)) ((* endfor *))}
\addtocategory{review}{((* for i in review  *)) (((i.ID))) ((* if not loop.last *)), ((* endif *)) ((* endfor *))}
\addtocategory{conferences}{((* for i in conference  *)) (((i.ID))) ((* if not loop.last *)), ((* endif *)) ((* endfor *))}
\addtocategory{talks}{((* for i in talks *)) (((i.ID))) ((* if not loop.last *)), ((* endif *)) ((* endfor *))}
\addtocategory{posters}{((* for i in posters *)) (((i.ID))) ((* if not loop.last *)), ((* endif *)) ((* endfor *))}

%% other stuff
% icons for the contact info
\usepackage{fontawesome5}
\usepackage{academicons}

% macros and environments
\newcommand{\Header}[1]{\\\multicolumn{3}{L{7in}}{\color{BrickRed}\Large{\spacedlowsmallcaps{#1}}}\\}
\newcommand{\Publication}[1]{\fullcite{#1} & \citeyear{#1}}
\newcommand{\CVEntry}[3]{#1 & #2 & #3}
\newenvironment{cv}
{
	\noindent\begin{longtable}{ >{\em}R{1in} L{5in} >{\em}R{0.875in} }
}{
    \end{longtable}
}

% have to load this last
\usepackage{hyperref} % Required for adding links	and customizing them
\hypersetup{colorlinks, breaklinks, urlcolor=CornellRed, linkcolor=CornellRed}

%---------------------------------------------------------------------

\begin{document}

%% Name and contact block

\begin{minipage}[t]{2.8in}
 \flushright {\footnotesize
 \href{(((data.person.affiliation_link)))}{(((data.person.affiliation)))}\\ \vspace{0in}
 (((data.person.address.line1)))\\ \vspace{0.01in} (((data.person.address.postcode)))\\ \vspace{-0.04in} (((data.person.address.country)))}
 \end{minipage}%
 \begin{minipage}[t]{2.5in}
   \flushright {\footnotesize  \texttt{\href{mailto:(((data.person.email)))}{(((data.person.email)))}} \, \faEnvelope} \\ \vspace{-0.21in}
   \flushright {\footnotesize  \texttt{\href{(((data.person.web)))}{(((data.person.web)))}} \, \faGlobe} \\ \vspace{-0.195in}
   \flushright {\footnotesize
   \texttt{\href{https://github.com/(((data.person.github)))}{(((data.person.github)))}} \, \faGithub} \\ \vspace{-0.185in}
   \flushright {\footnotesize
   \texttt{\href{https://scholar.google.com/citations?user=(((data.person.googlescholar)))}{(((data.person.first_name))) (((data.person.last_name)))}} \, \aiGoogleScholar}

 \end{minipage}

 \bigskip

 %% Name
 \quad\noindent{\LARGE\bfseries \textcolor{CornellGray}{(((data.person.first_name))) (((data.person.last_name)))}}
 \reversemarginpar

\bigskip

%% Research Interests
((* set sect = data.sections | select_by_attr_name("title", "Research Interests") *))
\section{(((sect.title | lower)))}

\mbox{}\vspace{-\dimexpr\baselineskip\relax}

\begin{itemize}[label={}]
((* for i in sect.entries.interests *))
\item (((i.name)))
((* endfor *))
\end{itemize}

%% Appointments
((* set sect = data.sections | select_by_attr_name("title", "Appointments") *))
\section{(((sect.title | lower)))}

\mbox{}\vspace{-\dimexpr\baselineskip\relax}

\begin{itemize}[label={}]
((* for i in sect.entries.appointments | sort_cast_int("start", reverse=True) *))
\item (((i.title))), (((i.dept | escape_tex))), (((i.univ))), (((i.start)))--(((i.end)))
((* endfor *))
\end{itemize}

%% Education
((* set sect = data.sections | select_by_attr_name("title", "Education")*))
\section{(((sect.title | lower)))}

\mbox{}\vspace{-\dimexpr\baselineskip\relax}

\begin{itemize}[label={}]
((* for i in sect.entries.degrees | sort_cast_int("year", reverse=True) *))
\item (((i.degree))), (((i.subject | escape_tex))), (((i.school))), (((i.year)))
((* endfor *))
\end{itemize}

%% Publications
\section{publications}
\nocite{*}
\printbibliography[title={Peer-Reviewed Journal Articles}, category=papers]

\printbib{review}


\end{document}
